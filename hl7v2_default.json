{
  "parser_settings": {
    "version": "omni.2.1",
    "file_format_type": "edi"
  },
  "file_declaration": {
    "segment_delimiter": "\n",
    "element_delimiter": "|",
    "component_delimiter": "^",
    "segment_declarations": [
        {
            "name": "patient",
            "type": "segment_group",
            "is_target": true,
            "child_segments": [
                {
                    "name": "MSH",
                    "elements": [
                      {"name": "sending_facility", "index": 3},
                      {"name": "datetime_of_message", "index": 6},
                      {"name": "message_trigger", "index": 8},
                      {"name": "message_control_id", "index": 9}
                    ]
                },
                {
                    "name": "EVN",
                    "min": 0,
                    "elements": [
                        {"name": "message_typecode", "index": 1}
                    ]
                },
                {
                    "name": "PID",
                    "min": 0,
                    "elements": [
                        {"name": "mrn", "index": 3, "component_index": 1, "default": ""},
                        {"name": "last_name", "index": 5, "component_index": 1, "default": ""},
                        {"name": "first_name", "index": 5, "component_index": 2, "default": ""},
                        {"name": "middle_name", "index": 5, "component_index": 3, "default": ""},
                        {"name": "dob", "index": 7, "default": ""},
                        {"name": "gender", "index": 8, "default": "Unknown"},
                        {"name": "address_1", "index": 11, "component_index": 1, "default": ""},
                        {"name": "address_2", "index": 11, "component_index": 2, "default": ""},
                        {"name": "city", "index": 11, "component_index": 3, "default": ""},
                        {"name": "state", "index": 11, "component_index": 4, "default": ""},
                        {"name": "zip", "index": 11, "component_index": 5, "default": ""},
                        {"name": "country", "index": 11, "component_index": 6, "default": ""},
                        {"name": "address_type", "index": 11, "component_index": 7, "default": "H"},
                        {"name": "home_phone", "index": 13, "component_index": 1, "default": ""},
                        {"name": "home_phone_type", "index": 13, "component_index": 3, "default": ""},
                        {"name": "work_phone", "index": 14, "component_index": 1, "default": ""},
                        {"name": "work_phone_type", "index": 14, "component_index": 3, "default": ""},
                        {"name": "marital_status", "index": 16, "default": "Unknown"},
                        {"name": "ssn", "index": 19, "default": ""},
                        {"name": "multiple_birth", "index": 24, "default": ""},
                        {"name": "birth_order", "index": 25, "default": ""},
                        {"name": "admit_date", "index": 44, "default": ""},
                        {"name": "discharge_date", "index": 45, "default": ""}
                    ]
                },
                {"name": "NK1","min": 0},
                {"name": "PV1","min": 0,
                    "elements": [
                        {"name": "attending_physician_id", "index": 7, "component_index": 1, "default": ""},
                        {"name": "attending_physician_first_name", "index": 7, "component_index": 2, "default": ""},
                        {"name": "attending_physician_last_name", "index": 7, "component_index": 3, "default": ""},
                        {"name": "attending_physician_type_code", "index": 7, "component_index": 13, "default": ""},
                        {"name": "referring_physician_id", "index": 8, "component_index": 1, "default": ""},
                        {"name": "referring_physician_first_name", "index": 8, "component_index": 2, "default": ""},
                        {"name": "referring_physician_last_name", "index": 8, "component_index": 3, "default": ""},
                        {"name": "referring_physician_type_code", "index": 8, "component_index": 13, "default": ""},
                        {"name": "financial_class", "index": 20, "default": ""},
                        {"name": "admit_datetime", "index": 44, "default": ""},
                        {"name": "discharge_datetime", "index": 45, "default": ""}
                    ]
                },
                {"name": "DG1","min": 0},
                {"name": "GT1","min": 0,
                    "elements": [
                        {"name": "last_name", "index": 3, "component_index": 1, "default": ""},
                            {"name": "first_name", "index": 3, "component_index": 2, "default": ""},
                            {"name": "middle_name", "index": 3, "component_index": 3, "default": ""},
                            {"name": "address_1", "index": 5, "component_index": 1, "default": ""},
                            {"name": "address_2", "index": 5, "component_index": 2, "default": ""},
                            {"name": "city", "index": 5, "component_index": 3, "default": ""},
                            {"name": "state", "index": 5, "component_index": 4, "default": ""},
                            {"name": "zip", "index": 5, "component_index": 5, "default": ""},
                            {"name": "country", "index": 5, "component_index": 6, "default": ""},
                            {"name": "address_type", "index": 5, "component_index": 7, "default": "H"},
                            {"name": "home_phone", "index": 6, "component_index": 1, "default": ""},
                            {"name": "home_phone_type", "index": 6, "component_index": 3, "default": ""},
                            {"name": "work_phone", "index": 7, "component_index": 1, "default": ""},
                            {"name": "work_phone_type", "index": 7, "component_index": 3, "default": ""},
                            {"name": "dob", "index": 8, "default": ""},
                            {"name": "gender", "index": 9, "default": "Unknown"},
                            {"name": "marital_status", "index": 30, "default": "Unknown"},
                            {"name": "ssn", "index": 12, "default": ""}
                    ]
                },
                {"name": "insurance", "type":"segment_group","min": 0, "max": -1,
                    "child_segments": [
                        {
                            "name": "IN1",
                            "elements": [
                                {"name": "set_id", "index": 1, "default": "1"},
                                {"name": "plan_id", "index": 2, "component_index": 1, "default": "00000"},
                                {"name": "plan_name", "index": 2, "component_index": 2, "default": "00000"},
                                {"name": "company_id", "index": 3, "component_index": 1, "default": "00000"},
                                {"name": "company_name", "index": 4, "component_index": 1, "default": ""},
                                {"name": "address_1", "index": 5, "component_index": 1, "default": ""},
                                {"name": "address_2", "index": 5, "component_index": 2, "default": ""},
                                {"name": "city", "index": 5, "component_index": 3, "default": ""},
                                {"name": "state", "index": 5, "component_index": 4, "default": ""},
                                {"name": "zip", "index": 5, "component_index": 5, "default": ""},
                                {"name": "country", "index": 5, "component_index": 6, "default": ""},
                                {"name": "address_type", "index": 5, "component_index": 7, "default": ""},
                                {"name": "insurance_phone", "index": 7, "component_index": 1, "default": ""},
                                {"name": "insurance_phone_type", "index": 7, "component_index": 3, "default": ""},
                                {"name": "group_number", "index": 8, "default": ""},
                                {"name": "group_employer_id", "index": 10,  "component_index": 1, "default": ""},
                                {"name": "group_employer_name", "index": 11,  "component_index": 1, "default": ""},
                                {"name": "plan_effective_date", "index": 12, "default": ""},
                                {"name": "plan_expiration_date", "index": 13, "default": ""},
                                {"name": "auth_number", "index": 14,  "component_index": 1, "default": ""},
                                {"name": "auth_date", "index": 14,  "component_index": 2, "default": ""},
                                {"name": "plan_type", "index": 15, "default": ""},
                                {"name": "insured_first_name", "index": 16, "component_index": 1, "default": ""},
                                {"name": "insured_last_name", "index": 16, "component_index": 2, "default": ""},
                                {"name": "insured_patient_relationship", "index": 17, "default": ""},
                                {"name": "insured_address_1", "index": 19, "component_index": 1, "default": ""},
                                {"name": "insured_address_2", "index": 19, "component_index": 2, "default": ""},
                                {"name": "insured_city", "index": 19, "component_index": 3, "default": ""},
                                {"name": "insured_state", "index": 19, "component_index": 4, "default": ""},
                                {"name": "insured_zip", "index": 19, "component_index": 5, "default": ""},
                                {"name": "insured_country", "index": 19, "component_index": 6, "default": ""},
                                {"name": "insured_address_type", "index": 19, "component_index": 7, "default": "H"},
                                {"name": "policy_number", "index": 36, "default": ""}
                            ]
                        },
                        {
                            "name": "IN2", "min": 0,
                            "elements": [
                                {"name": "insured_ssn", "index": 2, "default": ""}
                            ]
                        },
                        {"name": "IN3","min": 0},
                        {"name": "ROL","min": 0}
                    ]
                }

            ]
        }
	  ]
  },
  "transform_declarations": {
    "FINAL_OUTPUT": {
      "object": {
        "resourceType": {"const": "Bundle"},
        "id": {"const": "aa948bbf-a76a-48e2-845c-cccccb93ca4d"},
        "type": {"const": "transaction"},
        "entry": {
          "array": [
            {"template": "message_header_resource"},
            {"template": "organization_facility_resource"}
          ]
        }
      }
    },
    "message_header_resource": {
      "object": {
        "fullUrl": {"const": "urn:uuid:11ebe121-cfdc-4613-9bf2-983a382c0001"},
        "resource": {
          "object": {
            "resourceType": {"const": "MessageHeader"},
            "extension": {
              "array": [
                {
                  "object": {
                    "url": {"const": "https://smilecdr.com/fhir/ns/StructureDefinition/messageheader-source-message-id"},
                    "valueString": {"template": "transform_message_header_control_id"}
                  }
                }
              ]
            },
            "eventCoding": {
              "object": {
                "system": {"const": "http://terminology.hl7.org/CodeSystem/v2"},
                "code": {"xpath": "EVN/message_typecode"}
              }
            },
            "sender": {
              "object": {
                "identifier": {
                  "object": {
                    "system": {"const": "http://abc.com2"},
                    "value": {"const": "sender"}
                  }
                }
              }
            },
            "source": {
              "object": {
                "name": {"const": "SourceApp"},
                "endpoint": {"const": "SourceApp"}
              }
            }
          }
        },
        "request": {
          "object": {
            "method": {"const": "PUT"},
            "url": {"template": "transform_message_header_identifier"}
          }
        }
      }
    },
    "organization_facility_resource": {
      "object": {
        "fullUrl": {"const": "urn:uuid:11ebe121-cdef-4613-9bf2-983a382cdef7"},
        "resource": {
          "object": {
            "resourceType": {"const": "Organization"},
            "identifier": {
              "array": [
                {
                  "object": {
                    "system": {"const": "https://pediatrix.com/fhir/NamingSystem/facilityId-id"},
                    "value": {"const": "{{FacilityId}}"}
                  }
                }
              ]
            }
          }
        },
        "request": {
          "object": {
            "method": {"const": "POST"},
            "url": {"const": "Organization"},
            "ifNoneExist": {"const": "identifier=https://pediatrix.com/fhir/NamingSystem/facilityId-id|{{FacilityId}}"}
          }
        }
      }
    },
    "transform_marital_code": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "if (val) {switch(val.substring(0,1).toUpperCase()) {case 'M': 'M'; break; case 'S': 'U'; break; case 'D': 'D'; break; default: ''};} else {''}"},
                {"const": "val"}, {"xpath": "."}
            ]
        }
    },
    "transform_marital_display": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "if (val) {switch(val.substring(0,1).toUpperCase()) {case 'M': 'Married'; break; case 'S': 'Unmarried'; break; case 'D': 'Divorced'; break; default: ''};} else {''}"},
                {"const": "val"}, {"xpath": "."}
            ]
        }
    },
    "transform_gender_code": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "if (val) {switch(val.substring(0,1).toUpperCase()) {case 'M': 'male'; break; case 'F': 'female'; break; default: 'unknown'};} else {'unknown'}"},
                {"const": "val"}, {"xpath": "."}
            ]
        }
    },
    "transform_date": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "dt===null ? '' : dt.substring(0,10);"},
                {"const": "dt"},{
                    "custom_func": {
                        "name": "dateTimeToRFC3339",
                        "args": [
                            { "xpath": "." },
                            { "const": "", "_comment": "fromTZ" },
                            { "const": "", "_comment": "toTZ" }
                        ]
                    }
                }
            ]
        }
    },
    "transform_datetime": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "dt===null ? '' : dt.substring(0,10);"},
                {"const": "dt"},{
                    "custom_func": {
                        "name": "dateTimeToRFC3339",
                        "args": [
                            { "xpath": "." },
                            { "const": "", "_comment": "fromTZ" },
                            { "const": "", "_comment": "toTZ" }
                        ]
                    }
                }
            ]
        }
    },
    "transform_patient_identifier": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "mrn == '' ? '' : 'Patient/' + mrn"},
                {"const": "mrn"}, {"xpath": "mrn"}
            ]
        }
    },
    "transform_insurance_identifier": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "planid == '' ? '' : 'Insurance/' + planid"},
                {"const": "planid"}, {"xpath": "plan_id"}
            ]
        }
    },
    "transform_guarantor_identifier": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "guarantor_number == '' ? '' : 'RelatedPerson/' + guarantor_number"},
                {"const": "guarantor_number"}, {"xpath": "guarantor_number"}
            ]
        }
    },
    "transform_attending_physician_identifier": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "npi == '' ? '' : 'Provider/' + npi"},
                {"const": "npi"}, {"xpath": "attending_physician_id"},
                {"const": "lname"}, {"xpath": "attending_physician_last_name"},
                {"const": "fname"}, {"xpath": "attending_physician_first_name"}
            ]
        }
    },
    "transform_referring_physician_identifier": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "npi == '' ? '' : 'Provider/' + npi"},
                {"const": "npi"}, {"xpath": "referring_physician_id"},
                {"const": "lname"}, {"xpath": "referring_physician_last_name"},
                {"const": "fname"}, {"xpath": "referring_physician_first_name"}
            ]
        }
    },
    "transform_address_use": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "if (val) {switch(val.toUpperCase()) {case 'P': 'home'; break; case 'H': 'home'; break; case 'M': 'billing'; break; case 'O': 'work'; break; default: ''};} else {'';}"},
                {"const": "val"}, {"xpath": "."}
            ]
        }
    },
    "transform_phone_type": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "if (val) {switch(val.toUpperCase()) {case 'CP': 'mobile'; default: 'home'};} else {'home'}"},
                {"const": "val"}, {"xpath": "."}
            ]
        }
    },
    "transform_insurance_kind": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "if (val) {switch(val.toUpperCase()) {case 'SELF': 'self-pay'; break; case '': 'other'; break; default: 'insurance'};} else {'insurance'}"},
                {"const": "val"}, {"xpath": "."}
            ]
        }
    },
    "transform_employer_organization_identifier": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "emp_name !== null && emp_id !== null ? emp_id + '-' + emp_name : ''"},
                {"const": "emp_name"}, {"xpath": "IN1/group_employer_name"},
                {"const": "emp_id"}, {"xpath": "IN1/group_employer_id"}
            ]
        }
    },
    "transform_relatedperson_subscriber_identifier": {
        "custom_func": {
            "name": "javascript",
            "args": [
                {"const": "insured_lname !== null && insured_fname !== null ? insured_fname + ' ' + insured_lname : ''"},
                {"const": "insured_lname"}, {"xpath": "IN1/insured_last_name"},
                {"const": "insured_fname"}, {"xpath": "IN1/insured_first_name"}
            ]
        }
    },
    "transform_message_header_identifier": {
      "custom_func": {
          "name": "concat",
          "args": [
              { "const": "MessageHeader?control-id=" },
              { "template": "transform_message_header_control_id" }
          ]
      }
    },
    "transform_message_header_control_id": {
        "custom_func": {
            "name": "concat",
            "args": [
                { "xpath": "MSH/message_control_id" },
                { "xpath": "PID/mrn" },
                { "xpath": "MSH/datetime_of_message" }
            ]
        }
    }
  }
}
